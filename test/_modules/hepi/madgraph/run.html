<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>hepi.madgraph.run &mdash; HEPi  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> HEPi
          </a>
              <div class="version">
                0.2.0-8-g36b7cdde
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Versions:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://apn-pucky.github.io/HEPi/">Stable</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apn-pucky.github.io/HEPi/test/">Dev</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/APN-Pucky/HEPi">GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/demo_resummino.html">Resummino example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_distribute.html">Distribute resummino run files to clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_interpolate.html">Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_madgraph.html">MadGraph example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_pyslha.html">pyslha comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_spheno.html">SPheno example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test_write.html">Result writing example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Module:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/hepi/index.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hepi</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">HEPi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../hepi.html">hepi</a> &raquo;</li>
      <li>hepi.madgraph.run</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for hepi.madgraph.run</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;Runs MadGraph.&quot;&quot;&quot;
from typing import List
import subprocess
from string import Template
from hepi.input import Order
from hepi.run import RunParam, Runner
import pkgutil
from .. import Input, Result, get_output_dir
from .result import is_valid, parse_single
import time
import os


<div class="viewcode-block" id="MadGraphRunParams"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunParams">[docs]</a>class MadGraphRunParams(RunParam):
    &quot;&quot;&quot;Parameters for MadGraph.&quot;&quot;&quot;

    def __init__(self, dic, skip=False, madstr=True):
        super().__init__(skip)
        self.dic = dic
        # self.skip = skip
        self.madstr = madstr</div>


<div class="viewcode-block" id="MadGraphRunner"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner">[docs]</a>class MadGraphRunner(Runner):

<div class="viewcode-block" id="MadGraphRunner.orders"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner.orders">[docs]</a>    def orders(self) -&gt; List[Order]:
        return [Order.LO, Order.NLO]</div>

<div class="viewcode-block" id="MadGraphRunner._check_path"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._check_path">[docs]</a>    def _check_path(self) -&gt; bool:
        if os.path.exists(os.path.expanduser(self.get_path() +
                                             &quot;/bin/mg5_aMC&quot;)):
            self.set_path(self.get_path() + &quot;/bin/mg5_aMC&quot;)
            return True
        if self.get_path().endswith(&quot;mg5_aMC&quot;):
            return True
        return False</div>

<div class="viewcode-block" id="MadGraphRunner._check_input"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._check_input">[docs]</a>    def _check_input(self, param: Input, **kwargs) -&gt; bool:
        &quot;&quot;&quot;Checks input parameter for compatibility with Prospino&quot;&quot;&quot;
        return True</div>

<div class="viewcode-block" id="MadGraphRunner._is_valid"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._is_valid">[docs]</a>    def _is_valid(self, file: str, p: Input, d) -&gt; bool:
        if not super()._is_valid(file, p, d):
            return False
        return is_valid(file, p, d)</div>

<div class="viewcode-block" id="MadGraphRunner._parse_file"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._parse_file">[docs]</a>    def _parse_file(self, file: str) -&gt; Result:
        return parse_single(file)</div>

<div class="viewcode-block" id="MadGraphRunner._run"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._run">[docs]</a>    def _run(self,
             rps: List[RunParam],
             wait=True,
             parallel=True,
             sleep=0,
             **kwargs):
        # TODO clean up on exit emergency
        skipall = True
        for rp in rps:
            if not rp.skip:
                skipall = False
        template = &quot;&quot;
        if not skipall:
            lo = &quot;&amp;&amp; nice -n 5 {dir}/bin/calculate_xsect LO -f &gt;&gt; {out} &quot; if rps[
                0].dic[&quot;order&quot;] == Order.NLO else &quot;&quot;
            template =  \
                &#39;rm -rf {dir} &amp;&amp; cp -r &#39; + rps[0].dic[&quot;bdir&quot;] + \
                &#39; {dir}  &amp;&amp; cp {slha} {dir}/Cards/param_card.dat &amp;&amp; cp {run} {dir}/Cards/run_card.dat &amp;&amp; echo &quot;nb_core = 1&quot; &gt;&gt; {dir}/Cards/amcatnlo_configuration.txt &#39; + lo+ &#39;&amp;&amp; nice -n 5 {dir}/bin/calculate_xsect -f &gt;&gt; {out}  &amp;&amp; rm -rf {dir}&#39;
            print(rps[0].dic[&quot;out&quot;])
        if not rps[0].skip:
            mgcom = &#39;&#39;
            if rps[0].madstr:
                mgcom = &#39; --mode=&quot;MadSTR&quot;&#39;
            com = self.get_path() + mgcom + \
                &#39; --file {in} &gt;&gt; {out} &amp;&amp; cp {slha} {bdir}/Cards/param_card.dat &amp;&amp; cp {run} {bdir}/Cards/run_card.dat &amp;&amp; sed -i \&#39;s/.*= req_acc_FO/ 1 = req_acc_FO/g\&#39; {bdir}/Cards/run_card.dat &amp;&amp; echo &quot;automatic_html_opening = False&quot; &gt;&gt; {bdir}/Cards/amcatnlo_configuration.txt &amp;&amp; nice -n 5 {bdir}/bin/calculate_xsect -f&#39;
            pp = subprocess.Popen(com.format(**rps[0].dic), shell=True)
            pp.wait()
        # Run commands in parallel
        processes = []

        for rp in rps:
            if not rp.skip:
                command = template.format(**rp.dic)
                # print(command)
                process = subprocess.Popen(command, shell=True)
                processes.append(process)
                if not parallel:
                    process.wait()
                # Forced delay to prevent overloading clusters when registering jobs
                time.sleep(sleep)
        if wait:
            # Collect statuses
            output = [p.wait() for p in processes]
            return output
        return []</div>

<div class="viewcode-block" id="MadGraphRunner._prepare"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.MadGraphRunner._prepare">[docs]</a>    def _prepare(self, p: Input, **kwargs) -&gt; RunParam:
        rp = super()._prepare(p, **kwargs)
        name = rp.name
        if not rp.skip:
            d = p.__dict__
            d[&quot;dir&quot;] = get_output_dir() + name + &quot;.dir&quot;
            d[&quot;bdir&quot;] = get_output_dir() + name + &quot;.bdir&quot;

            infile = &quot;&quot;
            if p.order is Order.LO:
                infile = &quot;lo.mg&quot;
            elif p.order is Order.NLO:
                infile = &quot;nlo.mg&quot;
            else:
                raise ValueError(&quot;Madgraph only supported for LO/NLO.&quot;)

            data = pkgutil.get_data(__name__, infile).decode(&#39;utf-8&#39;)
            src = Template(data)
            result = src.substitute(d)
            open(get_output_dir() + name + &quot;.mg&quot;, &quot;w&quot;).write(result)
            if not rp.skip:
                open(get_output_dir() + name + &quot;.out&quot;,
                     &quot;w&quot;).write(result + &quot;\n\n&quot;)

            if p.order == Order.LO:
                mgfile = &quot;run_card_no_madstr.dat&quot;
            elif p.order == Order.NLO:
                mgfile = &quot;run_card_with_madstr.dat&quot;
            else:
                raise ValueError(&quot;Order must be one of LO/NLO in MadGraph.&quot;)

            if &quot;madstr&quot; in kwargs and not kwargs[&quot;madstr&quot;]:
                mgfile = &quot;run_card_no_madstr.dat&quot;
                rp.madstr = False
            else:
                rp.madstr = True
            data = pkgutil.get_data(__name__, mgfile).decode(&#39;utf-8&#39;)

            src = Template(data)
            result = src.substitute(d)
            open(get_output_dir() + name + &quot;.dat&quot;, &quot;w&quot;).write(result)
            if not rp.skip:
                open(get_output_dir() + name + &quot;.out&quot;,
                     &quot;a&quot;).write(result + &quot;\n\n&quot;)

            sname = d[&#39;slha&#39;]
            with open(get_output_dir() + sname, &#39;r&#39;) as f:
                #src = Template(f.read())
                #result = src.substitute(d)
                #open(get_input_dir() + sname + &quot;.in&quot;, &quot;w&quot;).write(result)
                if not rp.skip:
                    open(get_output_dir() + name + &quot;.out&quot;,
                         &quot;a&quot;).write(f.read() + &quot;\n\n&quot;)
            rp.dic = {
                &#39;in&#39;: get_output_dir() + name + &quot;.mg&quot;,
                &#39;dir&#39;: d[&quot;dir&quot;],
                &#39;bdir&#39;: d[&quot;bdir&quot;],
                &#39;run&#39;: get_output_dir() + name + &quot;.dat&quot;,
                &#39;slha&#39;: get_output_dir() + sname,
                &#39;out&#39;: get_output_dir() + name + &quot;.out&quot;,
                &#39;order&#39;: p.order
            }
            rp.out_file = rp.dic[&#39;out&#39;]
        return rp</div></div>


# Legacy
<div class="viewcode-block" id="default_madgraph_runner"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.default_madgraph_runner">[docs]</a>default_madgraph_runner = MadGraphRunner(&quot;/opt/MG5_aMC_v2_7_0/&quot;)</div>
&quot;&quot;&quot;Default MadGraph Runner to provide backward compatibility&quot;&quot;&quot;
<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.run">[docs]</a>run = default_madgraph_runner.run</div>
<div class="viewcode-block" id="set_path"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.set_path">[docs]</a>set_path = default_madgraph_runner.set_path</div>
<div class="viewcode-block" id="get_path"><a class="viewcode-back" href="../../../autoapi/hepi/madgraph/run/index.html#hepi.madgraph.get_path">[docs]</a>get_path = default_madgraph_runner.get_path</div>

# print(sp)
# names = queue(sp)
# run(names)
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, APN-Pucky.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>